name: CI

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main

env:
    ADDON_SLUG: evolution_api

jobs:
    # ===========================================================================
    # Lint and Validate
    # ===========================================================================
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Validate repository.json
              run: |
                  echo "Validating repository.json..."
                  python3 -c "import json; json.load(open('repository.json'))"
                  echo "✓ repository.json is valid JSON"

            - name: Validate config.yaml
              run: |
                  echo "Validating config.yaml..."
                  pip install pyyaml
                  python3 -c "import yaml; yaml.safe_load(open('${{ env.ADDON_SLUG }}/config.yaml'))"
                  echo "✓ config.yaml is valid YAML"

            - name: Validate build.yaml
              run: |
                  echo "Validating build.yaml..."
                  python3 -c "import yaml; yaml.safe_load(open('${{ env.ADDON_SLUG }}/build.yaml'))"
                  echo "✓ build.yaml is valid YAML"

            - name: Check required files
              run: |
                  echo "Checking required files..."
                  files=(
                    "repository.json"
                    "${{ env.ADDON_SLUG }}/config.yaml"
                    "${{ env.ADDON_SLUG }}/Dockerfile"
                    "${{ env.ADDON_SLUG }}/run.sh"
                    "${{ env.ADDON_SLUG }}/DOCS.md"
                    "${{ env.ADDON_SLUG }}/README.md"
                  )
                  for file in "${files[@]}"; do
                    if [ -f "$file" ]; then
                      echo "✓ $file exists"
                    else
                      echo "✗ $file missing"
                      exit 1
                    fi
                  done

            - name: Shellcheck run.sh
              uses: ludeeus/action-shellcheck@master
              with:
                  scandir: "./${{ env.ADDON_SLUG }}"
                  severity: warning
              continue-on-error: true

    # ===========================================================================
    # Build Docker Image
    # ===========================================================================
    build:
        name: Build (${{ matrix.arch }})
        runs-on: ubuntu-latest
        needs: lint
        strategy:
            fail-fast: false
            matrix:
                arch:
                    - amd64
                    - aarch64
                    - armv7
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Get build configuration
              id: config
              run: |
                  # Extract base image for architecture
                  BASE_IMAGE=$(python3 -c "
                  import yaml
                  with open('${{ env.ADDON_SLUG }}/build.yaml') as f:
                      config = yaml.safe_load(f)
                  print(config['build_from']['${{ matrix.arch }}'])
                  ")
                  echo "base_image=$BASE_IMAGE" >> $GITHUB_OUTPUT

                  # Map arch to Docker platform
                  case "${{ matrix.arch }}" in
                    amd64)   PLATFORM="linux/amd64" ;;
                    aarch64) PLATFORM="linux/arm64" ;;
                    armv7)   PLATFORM="linux/arm/v7" ;;
                  esac
                  echo "platform=$PLATFORM" >> $GITHUB_OUTPUT

            - name: Build image
              uses: docker/build-push-action@v5
              with:
                  context: ./${{ env.ADDON_SLUG }}
                  file: ./${{ env.ADDON_SLUG }}/Dockerfile
                  platforms: ${{ steps.config.outputs.platform }}
                  push: false
                  tags: local/${{ env.ADDON_SLUG }}:${{ matrix.arch }}
                  build-args: |
                      BUILD_FROM=${{ steps.config.outputs.base_image }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # ===========================================================================
    # Integration Tests (amd64 only for speed)
    # ===========================================================================
    test:
        name: Integration Tests
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Get base image
              id: config
              run: |
                  BASE_IMAGE=$(python3 -c "
                  import yaml
                  with open('${{ env.ADDON_SLUG }}/build.yaml') as f:
                      config = yaml.safe_load(f)
                  print(config['build_from']['amd64'])
                  ")
                  echo "base_image=$BASE_IMAGE" >> $GITHUB_OUTPUT

            - name: Build test image
              uses: docker/build-push-action@v5
              with:
                  context: ./${{ env.ADDON_SLUG }}
                  file: ./${{ env.ADDON_SLUG }}/Dockerfile
                  platforms: linux/amd64
                  push: false
                  load: true
                  tags: test/${{ env.ADDON_SLUG }}:latest
                  build-args: |
                      BUILD_FROM=${{ steps.config.outputs.base_image }}

            - name: Start container
              run: |
                  docker run -d \
                    --name evolution-test \
                    -p 8080:8080 \
                    -e SERVER_TYPE=http \
                    -e SERVER_PORT=8080 \
                    -e SERVER_URL=http://localhost:8080 \
                    -e LOG_LEVEL=DEBUG \
                    test/${{ env.ADDON_SLUG }}:latest

                  echo "Waiting for container to start..."
                  sleep 30

            - name: Container logs
              if: always()
              run: docker logs evolution-test

            - name: Run smoke tests
              run: |
                  chmod +x tests/scripts/smoke.sh
                  ./tests/scripts/smoke.sh http://localhost:8080
              continue-on-error: true

            - name: Install Newman
              run: npm install -g newman

            - name: Run Postman tests
              run: |
                  newman run tests/postman/evolution.collection.json \
                    --env-var "base_url=http://localhost:8080" \
                    --env-var "api_key=" \
                    --env-var "instance_name=ci_test" \
                    --reporters cli,json \
                    --reporter-json-export newman-results.json
              continue-on-error: true

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results
                  path: newman-results.json

            - name: Cleanup
              if: always()
              run: |
                  docker stop evolution-test || true
                  docker rm evolution-test || true

    # ===========================================================================
    # Release (on main branch only)
    # ===========================================================================
    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: [lint, build, test]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Get version
              id: version
              run: |
                  VERSION=$(python3 -c "
                  import yaml
                  with open('${{ env.ADDON_SLUG }}/config.yaml') as f:
                      config = yaml.safe_load(f)
                  print(config['version'])
                  ")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Check if tag exists
              id: tag_check
              run: |
                  if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create Release
              if: steps.tag_check.outputs.exists == 'false'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  name: Release v${{ steps.version.outputs.version }}
                  body: |
                      ## Evolution API Add-on v${{ steps.version.outputs.version }}

                      ### Installation
                      Add this repository to Home Assistant:
                      ```
                      https://github.com/${{ github.repository }}
                      ```

                      See [DOCS.md](evolution_api/DOCS.md) for setup instructions.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
